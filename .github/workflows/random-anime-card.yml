name: Update Random Anime Card

on:
  schedule:
    # Runs every 6 hours (4 times a day)
    - cron: "0 */6 * * *"
  # Allows manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-anime-card:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update README with random anime character
        run: |
          # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          # â•‘   DAFTAR KARAKTER ANIME - CUSTOMIZE DI SINI!                       â•‘
          # â•‘   Format: "NAMA_KARAKTER|URL_GAMBAR"                               â•‘
          # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          declare -a CHARACTERS=(
            "EmuVlucht|https://wallpapercave.com/pwp/wp15918974.jpg"
            "Mio Takamiya|https://wallpapercave.com/wp/wp9396919.jpg"
            "Ciel|https://i.pinimg.com/736x/14/92/97/149297a4b28b78ffad568cb13bc97082.jpg"
            "Rinne Berlinetta|https://cdn.myanimelist.net/r/200x268/images/characters/11/314866.webp"
            "Rimuru Tempest|https://cdn.myanimelist.net/r/200x268/images/characters/5/495796.webp"
            "Misaki Kirihara|https://cdn.myanimelist.net/r/200x268/images/characters/14/452222.webp"
            "Misaki Mei|https://cdn.myanimelist.net/r/200x268/images/characters/15/148131.webp"
            "Kurumi Tokisaki|https://cdn.myanimelist.net/r/200x268/images/characters/11/201897.webp"
            "Tohka Yatogami|https://cdn.myanimelist.net/r/200x268/images/characters/14/202193.webp"
            "Zero Two|https://cdn.myanimelist.net/r/200x268/images/characters/6/375955.webp"
            "Rem|https://cdn.myanimelist.net/r/200x268/images/characters/9/308217.webp"
            "Megumin|https://cdn.myanimelist.net/r/200x268/images/characters/7/447778.webp"
            "Asuna Yuuki|https://cdn.myanimelist.net/r/200x268/images/characters/2/295895.webp"
          )

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  STEP 1: Pilih karakter random
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          RANDOM_INDEX=$((RANDOM % ${#CHARACTERS[@]}))
          IFS='|' read -r CHAR_NAME CHAR_IMAGE <<< "${CHARACTERS[$RANDOM_INDEX]}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸŒ Selected Character: $CHAR_NAME"
          echo "ğŸ–¼ï¸  Image URL: $CHAR_IMAGE"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  STEP 2: Setup card data (deskripsi tetap)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          CARD_DESC="Hai, aku EmuVlucht. Seorang programmer biasa yang masih belajar. Aku sangat suka menonton anime dan catur :3"
          CARD_INSTAGRAM="emuvlucht"
          CARD_GITHUB="EmuVlucht"
          CARD_BG_COLOR="%23ecf0f1"
          CARD_PATTERN="leaf"
          CARD_PATTERN_COLOR="%23eaeaea"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  STEP 3: URL encode (handling special characters)
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          ENCODED_NAME=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$CHAR_NAME'''))")
          ENCODED_DESC=$(python3 -c "import urllib.parse; print(urllib.parse.quote('''$CARD_DESC'''))")

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  STEP 4: Build new Cardivo URL
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          NEW_CARD_URL="https://cardivo.vercel.app/api?name=${ENCODED_NAME}&description=${ENCODED_DESC}&image=${CHAR_IMAGE}&backgroundColor=${CARD_BG_COLOR}&instagram=${CARD_INSTAGRAM}&github=${CARD_GITHUB}&pattern=${CARD_PATTERN}&colorPattern=${CARD_PATTERN_COLOR}"

          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          #  STEP 5: Update README.md
          # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          if grep -q 'alt="EmuVlucht Card"' README.md; then
            # Escape & characters for sed (& has special meaning in sed replacement)
            ESCAPED_URL=$(echo "$NEW_CARD_URL" | sed 's/&/\\&/g')
            # Replace only the src attribute of img tag with alt="EmuVlucht Card"
            sed -i '/alt="EmuVlucht Card"/s|src="[^"]*"|src="'"$ESCAPED_URL"'"|' README.md
            echo "âœ… Card successfully updated!"
            echo "ğŸ“ New URL: $NEW_CARD_URL"
          else
            echo "âŒ Error: Card with alt='EmuVlucht Card' not found in README.md"
            echo "ğŸ’¡ Make sure your README.md has:"
            echo '   <img src="..." alt="EmuVlucht Card" />'
            exit 1
          fi

      - name: Commit and push changes
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add README.md

          # Check if there are changes to commit
          if git diff --quiet --cached; then
            echo "â„¹ï¸  No changes detected. Skipping commit."
            exit 0
          fi

          # Commit with informative message
          TIMESTAMP=$(date +'%Y-%m-%d %H:%M UTC')
          git commit -m "ğŸŒ Anime card rotation at $TIMESTAMP"

          # Pull latest changes and rebase to avoid conflicts
          git pull --rebase origin main || git pull --rebase origin master || true

          # Push with error handling (retry up to 3 times)
          for i in 1 2 3; do
            if git push; then
              break
            fi
            echo "âš ï¸  Push attempt $i failed, retrying..."
            git pull --rebase origin main || git pull --rebase origin master || true
            sleep 2
          done

          if git push; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âœ… SUCCESS! Changes pushed to repository"
            echo "ğŸ‰ Your profile card has been updated!"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          else
            echo "âŒ Failed to push changes"
            echo "ğŸ’¡ Check repository permissions"
            exit 1
          fi
