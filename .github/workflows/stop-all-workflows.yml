name: Stop All Workflows

on:
  workflow_dispatch:

permissions:
  contents: write
  actions: write

jobs:
  cancel-all:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Cancel all running workflows
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          echo "üõë Menghentikan semua workflow yang sedang berjalan..."
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
          
          # Dapatkan ID dari workflow saat ini agar tidak membatalkan diri sendiri
          CURRENT_RUN_ID=${{ github.run_id }}
          
          # Fungsi untuk membatalkan workflow
          cancel_workflow() {
            local status=$1
            local run_ids=$(gh run list -R ${{ github.repository }} --status "$status" --json databaseId,workflowName -q '.[] | select(.databaseId != '$CURRENT_RUN_ID') | .databaseId' 2>/dev/null || echo "")
            
            if [ -n "$run_ids" ]; then
              echo "Membatalkan $status workflows:"
              echo "$run_ids" | while read -r run_id; do
                if [ -n "$run_id" ]; then
                  echo "  ‚Ä¢ Run ID: $run_id"
                  gh run cancel -R ${{ github.repository }} "$run_id" 2>/dev/null || true
                fi
              done
            else
              echo "Tidak ada $status workflows untuk dibatalkan."
            fi
          }
          
          # Batalkan workflow yang sedang dalam antrian
          cancel_workflow "queued"
          
          # Batalkan workflow yang sedang berjalan
          cancel_workflow "in_progress"
          
          echo ""
          echo "‚úÖ Semua workflow yang berjalan telah dibatalkan!"
          echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

      - name: Optional - Hapus semua workflow runs
        if: true  # Ubah menjadi true jika ingin menghapus history juga
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          echo "üóëÔ∏è  Menghapus semua workflow runs (opsional)..."
          
          # Hapus berdasarkan status
          for status in failure cancelled success; do
            gh run list -R ${{ github.repository }} --status "$status" --json databaseId -q '.[].databaseId' 2>/dev/null | while read id; do
              gh run delete -R ${{ github.repository }} "$id" 2>/dev/null || true
            done
          done
          
          echo "‚úÖ History workflow telah dibersihkan!"

      - name: Summary
        run: |
          echo ""
          echo "üìã Ringkasan:"
          echo "‚Ä¢ Semua workflow yang sedang berjalan (queued/in_progress) telah dibatalkan"
          echo "‚Ä¢ Workflow dengan schedule akan tetap berjalan sesuai jadwal"
          echo "‚Ä¢ Untuk menghentikan permanen, nonaktifkan schedule di masing-masing workflow"
          echo ""
          echo "‚ö†Ô∏è  Catatan: Workflow yang sudah selesai (success/failure/cancelled) tidak terpengaruh"
          echo "   Gunakan opsi 'Hapus semua workflow runs' untuk membersihkan history."